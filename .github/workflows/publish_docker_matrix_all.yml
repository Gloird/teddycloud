name: Docker Image Publish Matrix (All)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      tcw_commit_hash:
        type: string

  push:
    branches:
      - master
      - develop
      - develop-gloird
    tags:
      - tc_nightly*
      - tc_v*.*.*
  pull_request:
    branches:
      - master
      - develop
      - develop-gloird

jobs:
  test_commit_hash:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          ref: ${{ inputs.tcw_commit_hash }}

      - name: Verify commit hash
        if: ${{ inputs.tcw_commit_hash != '' }}
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          if [ "$COMMIT_HASH" != "${{ inputs.tcw_commit_hash }}" ]; then
            echo "Error: Checked out commit hash ($COMMIT_HASH) does not match the expected hash (${{ inputs.tcw_commit_hash }})."
            exit 1
          else
            echo "Commit hash verified: $COMMIT_HASH"
          fi

  ubuntu:
    needs: test_commit_hash
    uses: ./.github/workflows/publish_docker_matrix_base.yml
    with:
      system: "ubuntu"
      dockerfile: "DockerfileUbuntu"
      platforms: '["linux/amd64"]'
      primary_image: true
      error_platforms: '[]'
      noasan_fallback_platforms: '[]'
      tcw_commit_hash: ${{ inputs.tcw_commit_hash }}

  # Smoke test: build image locally and run a quick /api/urlInfo call to capture logs
  ci_smoke:
    needs: ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Build local Docker image
        run: |
          docker build -t teddycloud:local -f DockerfileUbuntu .

      - name: Run container
        run: |
          docker run -d --name teddycloud_test -p 8080:8080 teddycloud:local || true
          sleep 8

      - name: Call /api/urlInfo (may fail)
        run: |
          curl -s -X POST "http://localhost:8080/api/urlInfo" -H "Content-Type: application/json" -d '{"url":"https://www.youtube.com/watch?v=HzRWSwimgVQ"}' -o response.json || true

      - name: Dump container logs
        run: |
          docker logs teddycloud_test --since 1m > container_logs.txt || true
          echo "--- RESPONSE ---"
          cat response.json || true
          echo "--- CONTAINER LOGS ---"
          sed -n '1,200p' container_logs.txt || true

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: teddycloud-ci-logs
          path: |
            container_logs.txt
            response.json

      - name: Cleanup
        run: |
          docker rm -f teddycloud_test || true
  # debian:
  #   needs: test_commit_hash
  #   uses: ./.github/workflows/publish_docker_matrix_base.yml
  #   with:
  #     system: "debian"
  #     dockerfile: "DockerfileDebian"
  #     platforms: '["linux/amd64", "linux/arm/v7", "linux/arm64/v8", "linux/i386", "linux/ppc64le", "linux/s390x"]'
  #     primary_image: false
  #     error_platforms: '["linux/s390x"]'
  #     noasan_fallback_platforms: '["linux/arm/v7", "linux/arm64/v8", "linux/ppc64le"]'
  #     tcw_commit_hash: ${{ inputs.tcw_commit_hash }}
  # alpine:
  #   needs: test_commit_hash
  #   uses: ./.github/workflows/publish_docker_matrix_base.yml
  #   with:
  #     system: "alpine"
  #     dockerfile: "DockerfileAlpine"
  #     platforms: '["linux/amd64", "linux/arm/v6", "linux/arm/v7", "linux/arm64/v8", "linux/ppc64le", "linux/s390x", "linux/386"]'
  #     primary_image: false
  #     error_platforms: "[]"
  #     noasan_fallback_platforms: "[]"
  #     tcw_commit_hash: ${{ inputs.tcw_commit_hash }}

  # ubuntuAsanTest:
  #   needs: test_commit_hash
  #   uses: ./.github/workflows/publish_docker_matrix_base.yml
  #   with:
  #     system: "ubuntuAsanTest"
  #     dockerfile: "DockerfileUbuntu"
  #     platforms: '["linux/arm/v7", "linux/arm64/v8", "linux/ppc64le"]'
  #     primary_image: false
  #     error_platforms: '["linux/arm/v7", "linux/arm64/v8", "linux/ppc64le"]'
  #     noasan_fallback_platforms: "[]"
  #     skip_empty_merge: true
  #     tcw_commit_hash: ${{ inputs.tcw_commit_hash }}
  # debianAsanTest:
  #   needs: test_commit_hash
  #   uses: ./.github/workflows/publish_docker_matrix_base.yml
  #   with:
  #     system: "debianAsanTest"
  #     dockerfile: "DockerfileDebian"
  #     platforms: '["linux/arm/v7", "linux/arm64/v8", "linux/ppc64le"]'
  #     primary_image: false
  #     error_platforms: '["linux/arm/v7", "linux/arm64/v8", "linux/ppc64le"]'
  #     noasan_fallback_platforms: "[]"
  #     skip_empty_merge: true
  #     tcw_commit_hash: ${{ inputs.tcw_commit_hash }}